<div class="container">
  <div class="row">
    <div class="col-md-6">
      <p><strong>IQTest:</strong> <%= @iqtest.name %></p>

      <% if @question.imageq.attached? %>
        <%= cl_image_tag @question.imageq.key, width: 300, height: 300, crop: :fill %>
      <% end %>

      <% if user_signed_in? %> <!-- Ajout: Seulement si l'utilisateur est connecté -->
        <h1> <strong>Question:</strong>  <%= @question.contentq %></h1>

        <% if policy(@question).edit? %>
          <%= link_to "Edit", edit_iqtest_question_path(@iqtest, @question) %> |
        <% end %>

        <% if policy(@question).destroy? %>
          <%= button_to "Destroy", iqtest_question_path(@iqtest, @question), class: "btn btn-danger", method: :delete, data: { confirm: 'Are you sure?' } %>
        <% end %>
      <% end %> <!-- Fin de l'ajout -->

    </div>

    <% if !current_user || !current_user.admin? %>
      <div class="col-md-6">
        <h2>Options:</h2>
        <ul>
          <% @options.each do |option| %>
            <li>
              <% if option.image.attached? %>
                <!-- Utilisation d'un conteneur pour encapsuler l'image et ses attributs de données -->
                <div class="option-container" data-question-id="<%= @question.id %>" data-option-id="<%= option.id %>">
                  <%= link_to cl_image_tag(option.image.key, width: 100, height: 100, crop: :fill), next_question_path(iqtest_id: @iqtest.id, id: @question.id, selected_option_id: option.id), class: 'option-link' %>
                </div>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <% if current_user && current_user.admin? %>
      <div class="col-md-6">
        <h2>Options:</h2>
        <ul>
          <% @options.each do |option| %>
            <li>
              <% if option.image.attached? %>
                <%= cl_image_tag(option.image.key, width: 100, height: 100, crop: :fill) %>
              <% end %>
              <%= option.reponse %> (Correct: <%= option.isreponsecorrect ? 'Yes' : 'No' %>)
              <% if policy(option).edit? %>
                <%= link_to 'Edit', edit_iqtest_question_option_path(@iqtest, @question, option) %>
              <% end %>
              <% if policy(option).destroy? %>
                <%= button_to 'Delete', iqtest_question_option_destroy_path(@iqtest, @question, option), class: "btn btn-danger", method: :delete, data: { confirm: 'Are you sure?' } %>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>
</div>

<%= link_to 'Back to IQTest', iqtest_path(@iqtest) %>

<script>// JavaScript pour gérer les clics sur les options
document.addEventListener('DOMContentLoaded', function() {
  const optionContainers = document.querySelectorAll('.option-container');
  const responses = []; // Tableau pour stocker les réponses sélectionnées par l'utilisateur

  optionContainers.forEach(container => {
    container.addEventListener('click', function(event) {
      event.preventDefault();

      const questionId = this.getAttribute('data-question-id');
      const optionId = this.getAttribute('data-option-id');

      // Ajouter la réponse sélectionnée au tableau des réponses
      responses.push({ question_id: questionId, option_id: optionId });

      // Vérifier s'il s'agit de la dernière question
      const lastQuestionId = <%= @iqtest.questions.last.id %>;
      const currentQuestionId = parseInt(questionId);

      if (currentQuestionId === lastQuestionId) {
        collectResponsesAndRedirect(responses);
      } else {
        // Rediriger vers la prochaine question
        window.location.href = this.children[0].href;
      }
    });
  });
});



function collectResponsesAndRedirect(responses) {
  fetch('/collect_responses', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json' // Ensure this line is added
    },
    body: JSON.stringify({ responses: responses })
  })
  .then(response => response.json())
  .then(data => {
    alert("Votre score est de : " + data.score);
  })
  .catch(error => {
    console.error('Erreur lors de la collecte des réponses :', error);
  });
}





</script>

<!-- Pagination -->
<div class="pagination">
  <% @iqtest.questions.each_with_index do |question, index| %>
    <%= link_to "Question #{index + 1}", iqtest_question_path(@iqtest, question) %>
  <% end %>
</div>
